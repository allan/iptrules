# A sample nonsense ruleset
set_nat_policy PREROUTING ACCEPT
set_nat_policy OUTPUT DROP
set_nat_policy POSTROUTING ACCEPT

set_filter_policy INPUT ACCEPT
set_filter_policy OUTPUT ACCEPT
set_filter_policy FORWARD ACCEPT

# Interfaces
ext_if='eth0'

setup_filter_chain lognreject
setup_filter_chain ipsec-incoming

input -p tcp --dport 22 -j ACCEPT
input --src 77.37.20.229 --proto UDP --dport 694 -j ACCEPT
input -j lognreject

forward --in-interface ipsec0 --jump ipsec-incoming
forward --src 172.23.24.25 -j REJECT 

forward -i eth0 -s 1.1.1.1 -d 172.23.24.25 -j ACCEPT
postrouting -o ipsec0 -s 1.1.1.1 -d 0/0 -j SNAT --to-source 2.2.2.2
prerouting -i $ext_if -d 1.1.1.1/25 -s 0/0 -j DNAT --to-destination 3.3.3.3

filter_chain ipsec-incoming -o $ext_if -d 172.30.75.190 -s 10.61.10.142 -p TCP
filter_chain ipsec-incoming -j DROP


# the result of the above ruleset, shown as iptables-save output:
#
# # Generated by iptables-save v1.3.6 on Wed Nov 26 18:44:37 2008
# *filter
# :INPUT ACCEPT [5:446]
# :FORWARD ACCEPT [0:0]
# :OUTPUT ACCEPT [25:3715]
# :ipsec-incoming - [0:0]
# :lognreject - [0:0]
# -A INPUT -p tcp -m tcp --dport 22 -j ACCEPT 
# -A INPUT -s 77.37.20.229 -p udp -m udp --dport 694 -j ACCEPT 
# -A INPUT -j lognreject 
# -A FORWARD -i ipsec0 -j ipsec-incoming 
# -A FORWARD -s 172.23.24.25 -j REJECT --reject-with icmp-port-unreachable 
# -A FORWARD -s 1.1.1.1 -d 172.23.24.25 -i eth0 -j ACCEPT 
# -A ipsec-incoming -s 10.61.10.142 -d 172.30.75.190 -o eth0 -p tcp 
# -A ipsec-incoming -j DROP 
# COMMIT
# # Completed on Wed Nov 26 18:44:37 2008
# # Generated by iptables-save v1.3.6 on Wed Nov 26 18:44:37 2008
# *nat
# :PREROUTING ACCEPT [1:64]
# :POSTROUTING ACCEPT [0:0]
# :OUTPUT DROP [5:420]
# -A PREROUTING -d 1.1.1.0/255.255.255.128 -i eth0 -j DNAT --to-destination 3.3.3.3 
# -A POSTROUTING -s 1.1.1.1 -o ipsec0 -j SNAT --to-source 2.2.2.2 
# COMMIT
# # Completed on Wed Nov 26 18:44:37 2008
